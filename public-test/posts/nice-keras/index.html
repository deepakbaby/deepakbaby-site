<!doctype html><html lang=en><head><title>NICE- Non-linear Independent Components Estimation: Insights and Implementation in Keras</title><style>:root{--bg-primary:#0f172a;--bg-secondary:#1e293b;--bg-card:rgba(255, 255, 255, 0.03);--text-primary:#fff;--text-secondary:#9ca3af;--text-muted:#6b7280;--border-color:rgba(255, 255, 255, 0.08);--orb-opacity:0.5;--toggle-bg:rgba(255, 255, 255, 0.1);--toggle-border:rgba(255, 255, 255, 0.2);--social-bg:rgba(255, 255, 255, 0.05);--social-border:rgba(255, 255, 255, 0.1);--mouse-border:rgba(255, 255, 255, 0.2);--wheel-bg:rgba(255, 255, 255, 0.4);--card-hover-border:rgba(59, 130, 246, 0.3);--card-hover-shadow:rgba(59, 130, 246, 0.15)}[data-theme=light]{--bg-primary:#fafbfc;--bg-secondary:#ffffff;--bg-card:transparent;--text-primary:#1e293b;--text-secondary:#475569;--text-muted:#94a3b8;--border-color:rgba(0, 0, 0, 0.06);--orb-opacity:0.1;--toggle-bg:rgba(0, 0, 0, 0.04);--toggle-border:rgba(0, 0, 0, 0.08);--social-bg:transparent;--social-border:rgba(0, 0, 0, 0.1);--mouse-border:rgba(0, 0, 0, 0.12);--wheel-bg:rgba(0, 0, 0, 0.2);--card-hover-border:rgba(59, 130, 246, 0.3);--card-hover-shadow:rgba(59, 130, 246, 0.08);--card-bg:transparent;--card-border:rgba(0, 0, 0, 0.04);--timeline-color:#3b82f6;--section-bg:#ffffff;--glow-color:rgba(59, 130, 246, 0.08)}body{background-color:var(--bg-primary);color:var(--text-primary)}</style><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.c783c6e6b679af484325eb2b13483dfca8aa9b848c0b6e81bd4022ece7a9a0ef.css integrity="sha256-x4PG5rZ5r0hDJesrE0g9/Kiqm4SMC26BvUAi7OepoO8="><link rel=icon type=image/png href=/images/site/favicon_hu_be34366aac4a405.png><meta property="og:title" content="Deepak Baby"><meta property="og:type" content="website"><meta property="og:description" content="Personal website of Deepak Baby."><meta property="og:image" content="/images/author/deepak.jpeg"><meta property="og:url" content="https://deepakbaby.in"><meta name=description content="NICE- Non-linear Independent Components Estimation: Insights and Implementation in Keras"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><link rel=stylesheet href=/css/collapsible-sidebars.css><link rel=stylesheet href=/css/comments.css><script integrity="sha256-DO4ugzEwhTW1Id1UIWn0gUJWaebCYOypeTit6LW4QB4=">let theme=localStorage.getItem("theme-scheme")||localStorage.getItem("darkmode:color-scheme")||"light";theme==="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid wrapper"><button class=theme-toggle-fixed id=themeToggle aria-label="Toggle theme"><svg class="sun-icon" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364-.707-.707M6.343 6.343l-.707-.707m12.728.0-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><svg class="moon-icon" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003.0 0012 21a9.003 9.003.0 008.354-5.646z"/></svg></button><nav class=scroll-navbar id=scrollNavbar><div class=navbar-container><a href=https://deepakbaby.in/ class=navbar-brand><img src=/images/site/favicon.png alt class=navbar-favicon>
Deepak Baby</a><div class=navbar-links><a href=https://deepakbaby.in/#about class=navbar-link>About</a>
<a href=https://deepakbaby.in/#experiences class=navbar-link>Experience</a>
<a href=/posts class=navbar-link>Blog</a>
<a href=https://deepakbaby.in/publications class=navbar-link>Publications</a></div><button class=theme-toggle-navbar id=themeToggleNav aria-label="Toggle theme"><svg class="sun-icon" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364-.707-.707M6.343 6.343l-.707-.707m12.728.0-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><svg class="moon-icon" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003.0 0012 21a9.003 9.003.0 008.354-5.646z"/></svg></button></div></nav><style>.theme-toggle-fixed{position:fixed;top:1.5rem;right:1.5rem;width:44px;height:44px;border-radius:50%;background:var(--toggle-bg,rgba(255,255,255,.1));border:1px solid var(--toggle-border,rgba(255,255,255,.2));display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;color:var(--text-primary,#fff);z-index:1000}.theme-toggle-fixed:hover{background:var(--toggle-hover-bg,rgba(255,255,255,.2));transform:scale(1.05)}.theme-toggle-fixed svg{width:22px;height:22px}.scroll-navbar.visible~.theme-toggle-fixed,.theme-toggle-fixed.hidden{opacity:0;pointer-events:none}.scroll-navbar.visible~.section-wrapper .theme-toggle-fixed,body:has(.scroll-navbar.visible) .theme-toggle-fixed{opacity:0;pointer-events:none}.scroll-navbar{position:fixed;top:0;left:0;right:0;background:var(--navbar-bg,rgba(15,23,42,.95));backdrop-filter:blur(20px);border-bottom:1px solid var(--border-color,rgba(255,255,255,8%));z-index:999;transform:translateY(-100%);transition:transform .3s ease}.scroll-navbar.visible{transform:translateY(0)}.navbar-container{max-width:1200px;margin:0 auto;padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between}.navbar-brand{display:flex;align-items:center;gap:.75rem;font-family:inter,sans-serif;font-size:1.125rem;font-weight:500;color:var(--text-primary,#fff);text-decoration:none!important;transition:transform .3s ease,color .3s}.navbar-brand:hover,.navbar-brand:focus,.navbar-brand:active{transform:translateY(-2px);color:#3b82f6;text-decoration:none!important}.navbar-favicon{width:28px;height:28px;border-radius:6px}.navbar-links{display:flex;gap:2rem}.navbar-link{font-family:inter,sans-serif;font-size:.875rem;font-weight:400;color:var(--text-secondary,rgba(255,255,255,.7));text-decoration:none!important;transition:transform .3s ease,color .3s;display:inline-block}.navbar-link:hover,.navbar-link:focus,.navbar-link:active{transform:translateY(-2px);color:var(--text-primary,#fff);text-decoration:none!important}.theme-toggle-navbar{width:36px;height:36px;border-radius:50%;background:var(--toggle-bg,rgba(255,255,255,.1));border:1px solid var(--toggle-border,rgba(255,255,255,.2));display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;color:var(--text-primary,#fff)}.theme-toggle-navbar:hover{background:var(--toggle-hover-bg,rgba(255,255,255,.2))}.theme-toggle-navbar svg{width:18px;height:18px}.sun-icon{display:none}.moon-icon{display:block}[data-theme=light] .sun-icon{display:block}[data-theme=light] .moon-icon{display:none}[data-theme=light] .scroll-navbar{--navbar-bg:rgba(255, 255, 255, 0.98);box-shadow:0 1px 8px rgba(0,0,0,5%);border-bottom-color:transparent}@media(max-width:768px){.theme-toggle-fixed{top:1rem;right:1rem;width:40px;height:40px}.navbar-links{display:none}}</style><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("themeToggle"),a=document.getElementById("themeToggleNav"),t=document.getElementById("scrollNavbar"),n=document.documentElement,r=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark");n.setAttribute("data-theme",r);function s(){const t=n.getAttribute("data-theme"),e=t==="dark"?"light":"dark";n.setAttribute("data-theme",e),localStorage.setItem("theme",e)}e?.addEventListener("click",s),a?.addEventListener("click",s);const o=document.querySelector(".hero-section"),i=o?o.offsetHeight*.6:100;window.addEventListener("scroll",()=>{const n=window.pageYOffset;n>i?(t?.classList.add("visible"),e?.classList.add("hidden")):(t?.classList.remove("visible"),e?.classList.remove("hidden"))}),window.pageYOffset>i&&(t?.classList.add("visible"),e?.classList.add("hidden"))})</script><style>.type-posts .container-fluid.wrapper{max-width:none!important;width:100%!important;padding:0!important;margin:0!important;overflow-x:hidden!important}body.type-posts{overflow-x:hidden!important;width:100vw!important;max-width:100vw!important}html{overflow-x:hidden!important}</style><div class=modern-post-wrapper><section class=post-hero-section><div class=post-hero-overlay></div><div class=post-hero-image style=background-image:url(/images/default-hero.jpg)></div><div class=post-hero-content><div class=post-meta-badges><span class=post-category-badge>deep learning</span></div><h1 class=post-title>NICE- Non-linear Independent Components Estimation: Insights and Implementation in Keras</h1><div class=post-meta-info><div class=post-author><span class=author-name>Deepak Baby</span></div><div class=post-date-time><svg width="16" height="16" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v12a2 2 0 002 2z"/></svg>
<span>Tuesday, December 3, 2019</span>
<span class=meta-separator>•</span>
<svg width="16" height="16" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3A9 9 0 113 12a9 9 0 0118 0z"/></svg>
<span>8 min read</span></div></div><div class=post-tags-hero><a href=/tags/deep-learning class=tag-link>#deep learning</a>
<a href=/tags/keras class=tag-link>#keras</a>
<a href=/tags/generative-models class=tag-link>#generative models</a>
<a href=/tags/flow-based-models class=tag-link>#flow-based models</a>
<a href=/tags/nice class=tag-link>#nice</a>
<a href=/tags/normalizing-flows class=tag-link>#normalizing flows</a></div></div></section><div class=post-content-container><div class=post-content-grid><article class=post-article-content><div class=prose-content id=post-content><p>Keras implementation can be found <a href=https://deepakbaby.github.io/post/nice-keras/>here</a>.</p><p>Flow-based deep generative models have not gained much attention in the research community when compared to <a href=https://arxiv.org/abs/1406.2661>GANs</a> or <a href=https://arxiv.org/abs/1312.6114>VAEs</a>. This post discusses a flow-based model called <a href=https://arxiv.org/abs/1410.8516>NICE</a>, its advantages over the other generative models and finally an implementation in Keras.</p><p>While VAEs use an encoder that finds only an approximation of the latent variable corresponding to a datapoint, GANs doesnt even have an encoder to infer latents. In flow-based models, the latent variables can be infered exactly without any approximation. Flow-based models make use of reversible architecture (which will be explained below) which enables accurate inference, in addition to providing optimization over the exact log-likelihood of the data instead of a lower bound of it.</p><h3 id=flow-based-generative-models>Flow-based generative models</h3><p>In flow-based approaches the generative process for a datapoint $ \mathbf{x} $ is defined as:</p><p>$$\begin{equation}
\mathbf{z} \sim p (\mathbf{z}) \\\
\mathbf{x} = \mathbf{g}(\mathbf{z})
\end{equation}$$</p><p>where $\mathbf{z}$ is the latent variable with some tractable density $p(\mathbf{z})$ such as standard normal: $p(\mathbf{z}) = \mathcal{N}(\mathbf{z}; \mathbf{0}, \mathbf{I})$. The key aspect in flow-based approaches is that the function $\mathbf{g}$ is an invertible function (also called <em>bijective</em>) such that for every datapoint $\mathbf{x}$, the latent variable can be inferred by $\mathbf{z} = \mathbf{f}(\mathbf{x})=\mathbf{g}^{-1}(\mathbf{x})$.</p><p>The function $\mathbf{f}$ which maps the datapoint to the corresponding latent-variable is realised using a deep neural network. In addition, notice that $\mathbf{g}$ is the inverse of $\mathbf{f}$, therefore the neural network architecture should be carefully defined such that it is reversible or invertible. Therefore, we focus on functions where $\mathbf{f}$ (and $\mathbf
{g}$) is composed of a sequence of invertible transformations: $\mathbf{f} = \mathbf{f_1} \circ \mathbf{f_2} \circ \dots \circ \mathbf{f_K}$, such that the mapping from $\mathbf{x}$ to $\mathbf{z}$ can be written as:
$$\begin{equation}
\mathbf{x}\stackrel{\mathbf{f_1}}{\longleftrightarrow} \mathbf{h_1} \stackrel{\mathrm{\mathbf{f_1}}}{\longleftrightarrow} \mathbf{h_2} \dots \stackrel{\mathrm{\mathbf{f_K}}}{\longleftrightarrow} \mathbf{z}.
\end{equation}$$
Such a sequence of invertible transformations is also called normalizing flow.</p><p>Given an observed data variable $\mathbf{x} \in \mathcal{X}$, a simple probability distribution $p(\mathbf{z})$ with $\mathbf{z} \in \mathcal{Z}$, and a bijective function $\mathbf{f} : \mathcal{X} \rightarrow \mathcal{Z}$ (with $\mathbf{g} = \mathbf{f}^{-1}$), the change of variable formula defines a model distribution on $\mathcal{X}$ by
$$\begin{align}
p(\mathbf{x}) &= p(\mathbf{z})\left\vert \det \left( \dfrac{\partial \mathbf{z}}{\partial \mathbf{x}} \right) \right\vert \\\
\log p(\mathbf{x}) &= \log p(\mathbf{z}) + \log \left\vert \det \left( \dfrac{\partial \mathbf{z}}{\partial \mathbf{x}} \right) \right\vert \\\
&= \log p(\mathbf{z}) + \sum_{i=1, j=i-1}^{K} \log \left\vert \det \left( \dfrac{{\partial \mathbf{h_i}}}{{\partial \mathbf{h_j}}} \right) \right\vert
\end{align}$$
with $\mathbf{h_0} = \mathbf{x}$ and $\mathbf{h_K} = \mathbf{z}$.</p><p>The determinant of the Jacobian matrix $\partial \mathbf{h_i} / \partial \mathbf{h_j}$ is the change in density when $\mathbf{h_j}$ is transformed to $\mathbf{h_i}$ under the transformation $\mathbf{f_i}$. Thus, flow-based models require to compute this determinant as well. The second key aspect is to design the functions $\mathbf{f_i}$ such that the determinant of its Jacobian is easy to compute.</p><p>Thus, flow-based models require two important design choices on $\mathbf{f_i}$:</p><ol><li>Have reversible architecture</li><li>Design transformations whose determinant of Jacobians are easy to compute</li></ol><p>To satisfy these two requirements, the trick is to choose the transformations whose Jacobian is a triangular matrix, such that their determinnant can be simply computed as the product of its diagonal elements. Thus,
$$\begin{equation}
\log \left\vert \det \left( \dfrac{{\partial \mathbf{h_i}}}{{\partial \mathbf{h_j}}} \right) \right\vert = \sum \log \left\vert \text{diag}~ \left( \dfrac{{\partial \mathbf{h_i}}}{{\partial \mathbf{h_j}}} \right) \right\vert
\end{equation}$$
where, $\text{diag}(\cdot)$ takes the diagonal of the Jacobian matrix.</p><p>These models are trained (i.e., training the neural nets $\mathbf{f}$) such that the negative log-likelihood of $\mathbf{z}$ is minimized with respect to some prior distribution (more on this below).</p><p>To generate data, we can sample from the prior distribution $p(\mathbf{z})$ and do the inverse operation.</p><h3 id=nice-non-linear-independent-components-estimation>NICE: Non-linear Independent Components Estimation</h3><p>As mentioned before, the two key main aspects of flow-based approaches is <strong>easy determinant of the Jacobian</strong> and <strong>easy inverse</strong>. In NICE, the input data is split into two blocks $\mathbf{x} \rightarrow (\mathbf{x_1}, \mathbf{x_2})$ (say, even and odd indices). Then apply block transformation from $(\mathbf{x_1}, \mathbf{x_2})$ to $(\mathbf{h_1^1}, \mathbf{h_1^2})$ of the form:
$$\begin{align}
\mathbf{h_1^1} &= \mathbf{x_1} \\\
\mathbf{h_1^2} &= \mathbf{x_2} + \mathbf{m}(\mathbf{x_1})
\end{align}$$
where, $\mathbf{m}$ is an arbitrarily complex function (neural net). They call this transformation as an <em>Affine Coupling layer</em>. This transformation satisfies the two design choices:</p><ul><li><p>The inverse can be easily computed as:
$$\begin{align}
\mathbf{x_1} &= \mathbf{h_1^1} \\\
\mathbf{x_2} &= \mathbf{h_1^2} - \mathbf{m}(\mathbf{h_1^1})
\end{align}$$</p></li><li><p>The transformation $\mathbf{f}$ is (where $d$ and $e$ are the dimensions of $ \mathbf{x_1}$ and $\mathbf{x_2}$)
$$\begin{align}
\mathbf{h_1} = \begin{bmatrix} \mathbf{h_1^1} \\\ \mathbf{h_1^{2}} \end{bmatrix} = \begin{bmatrix} \mathbf{I_d} & 0 \\\ \mathbf{m}(\cdot) & \mathbf{I_e} \end{bmatrix} \begin{bmatrix} \mathbf{x_1} \\\ \mathbf{x_2} \end{bmatrix}
\end{align}$$
resulting in a Jacobian matrix
$$\begin{align}
\dfrac{\partial \mathbf{f}}{\partial \mathbf{x}} &= \begin{bmatrix} \dfrac{\partial \mathbf{h_1^1}}{\partial \mathbf{x_1}} & \dfrac{\partial \mathbf{h_1^1}}{\partial \mathbf{x_2}} \\\ \dfrac{\partial \mathbf{h_1^2}}{\partial \mathbf{x_1}} & \dfrac{\partial \mathbf{h_1^2}}{\partial \mathbf{x_2}} \end{bmatrix} \\\
&= \begin{bmatrix} \mathbf{I_d} & 0 \\\ \dfrac{\partial \mathbf{m}(\cdot)}{\partial \mathbf{x_1}} & \mathbf{I_e} \end{bmatrix}
\end{align}$$
whose determinant is unity. Notice that such a design not only enables easy compuatation of the determinant, but also lets us choose arbitrarily complex $\mathbf{m}(\cdot)$ since we dont have to compute its derivative to obtain the determinant.</p></li></ul><p>Similarly, inverse operation from $\mathbf{z}$ to $\mathbf{x}$ also results in a unit Jacobian determinant. Thus generating data also is easy with the NICE model.</p><p>In the NICE model, since all the transformations are volume preserving (unit Jacobian determinant), the resulting transformation will have equal weight over all dimensions, which is not desirable in practical applications. To address this, NICE also includes a scaling layer at the output that scales every dimension by a trainable weight $S_i$. This allows the model to give more weight on some dimensions and less on others.</p><p>Thus the nice criterion becomes maximizing the log-likelihood of the data distribution:
$$\begin{align}
\log p(\mathbf{x}) &= \log p(\mathbf{z}) + \log \left\vert \det \left( \dfrac{\partial \mathbf{z}}{\partial \mathbf{x}} \right) \right\vert \\\
&= \log p(\mathbf{z}) +\sum_{i=1}^D \log (\vert S_i \vert)
\end{align}$$</p><p>Further, NICE model assumes that the prior distribution is factorial: $p(\mathbf{z}) = \prod_{i=1}^{D} p(\mathbf{z_i})$. The training criterion for NICE is to maximize its log-likelihood or minimize the negative log-likelihood: $\mathcal{L} = - \log p(\mathbf{x})$</p><ul><li>For standard gaussian:<br>$\mathcal{L} = \sum_{i=1}^D 0.5 \cdot (\mathbf{z_i}^2 + \log 2\pi) - \log (\vert S_i \vert)$</li><li>For standard logistic:<br>$\mathcal{L} =\sum_{i=1}^D \log\left(1+\exp(\mathbf{z_i})\right) + \log(1+\exp(\mathbf{-z_i})) - \log (\vert S_i \vert) $</li></ul><p>As we stack multiple affine coupling layers to obtain more complex transformations. Since the transformation leaves one part of the data leaves unchanged, we can alternate the role of each part in subsequent coupling layers. Typically, 4 coupling layers are used so that all dimensions influence the one another. The scaling layer is paramterised exponentially $\exp(S_i)$ to have positive scaling.</p><p>In NICE the forward model maps the datapoint to the latent space and is trained to minimize the negative log-likelihood with respect to some prior distribution. And for inference, we sample from the prior distribution to get $\mathbf{h}$ and new datapoints $\mathbf{x}$ can be generated using the inverse flow. For a 4 layer architecture, the forward and inverse flow equations are,</p><table><thead><tr><th style=text-align:left>Forward Flow</th><th style=text-align:left>Inverse Flow</th></tr></thead><tbody><tr><td style=text-align:left>$$\begin{align}\mathbf{h_1^1} &= \mathbf{x_1} \\\ \mathbf{h_1^2} &= \mathbf{x_2} + \mathbf{m_1} ( \mathbf{x_1}) \end{align}$$</td><td style=text-align:left>$$\begin{align} \mathbf{h_4} = \exp(-S) \odot \mathbf{h}\end{align}$$</td></tr><tr><td style=text-align:left>$$\begin{align}\mathbf{h_2^2} &= \mathbf{h_1^2} \\\ \mathbf{h_2^1} &= \mathbf{h_1^1} + \mathbf{m_2} ( \mathbf{h_1^2}) \end{align}$$</td><td style=text-align:left>$$\begin{align} \mathbf{h_3^2} &= \mathbf{h_4^2} \\\ \mathbf{h_3^1} &= \mathbf{h_4^1} - \mathbf{m_4} ( \mathbf{h_4^2}) \end{align}$$</td></tr><tr><td style=text-align:left>$$\begin{align}\mathbf{h_3^1} &= \mathbf{h_2^1} \\\ \mathbf{h_3^2} &= \mathbf{h_2^2} + \mathbf{m_3} ( \mathbf{h_2^1}) \end{align}$$</td><td style=text-align:left>$$\begin{align} \mathbf{h_2^1} &= \mathbf{h_3^1} \\\ \mathbf{h_2^2} &= \mathbf{h_3^2} - \mathbf{m_3} ( \mathbf{h_3^1}) \end{align}$$</td></tr><tr><td style=text-align:left>$$\begin{align}\mathbf{h_4^2} &= \mathbf{h_3^2} \\\ \mathbf{h_4^1} &= \mathbf{h_3^1} + \mathbf{m_4} ( \mathbf{h_3^2}) \end{align}$$</td><td style=text-align:left>$$\begin{align} \mathbf{h_1^2} &= \mathbf{h_2^2} \\\ \mathbf{h_1^1} &= \mathbf{h_2^1} - \mathbf{m_2} ( \mathbf{h_2^2}) \end{align}$$</td></tr><tr><td style=text-align:left>$$\begin{align} \mathbf{h} = \exp(S) \odot \mathbf{h_4}\end{align}$$</td><td style=text-align:left>$$\begin{align} \mathbf{x_1} &= \mathbf{h_1^1} \\\ \mathbf{x_2} &= \mathbf{h_1^2} - \mathbf{m_1} ( \mathbf{h_1^1}) \end{align}$$</td></tr></tbody></table><hr><h3 id=implementation-notes>Implementation Notes</h3><p>As mentioned above, the NICE model is trained to minimize the negative log-likelihood with respect to a standard Gaussian or logistic distribution.</p><ul><li><p><strong>Getting the models correct:</strong> The main design challenge was to get the inverse model correct with its weights tied to the corresponding forward model. We can verify if the inverse model is correct even before training the model. Just take a test image from MNIST and pass it through the forward model. Then use the resulting output as input to the inverse model. If the inverse model is created with correct weights, it should yield the test image.</p></li><li><p><strong>Getting NaNs:</strong> For implementing the logistic loss $\log\left(1+\exp(\mathbf{z_i})\right) + \log(1+\exp(\mathbf{-z_i}))$, I initially used Keras backend as:</p></li></ul><pre tabindex=0><code>import keras.backend as K     
logistic_negloglikelihood = K.sum ( K.log (1 + K.exp(z)) +  K.log(1 + K.exp(-z)), axis=1 )
</code></pre><p>However, it was resulting in NaN after a few epochs. Then this was replaced with <code>softplus</code> function which computes $\log (1 + \exp(x))$ and the NaN issue was (magically!) gone.</p><pre tabindex=0><code>logistic_negloglikelihood = K.sum ( K.softplus(z) + K.softplus(-z), axis=1 )
</code></pre><ul><li><p><strong>Initialization:</strong> Initially, I was using the default <code>glorot_uniform</code> initialization of keras which was not resulting in the log-likelihoods given in the paper. <a href=https://github.com/laurent-dinh/nice>Dinh&rsquo;s original implementation</a> in Theano used an initialization from a uniform distribution in $[-0.01,0.01]$. Using the same initialization for the Dense layers resulted in better log-likelihoods.</p></li><li><p><strong>Batch-size:</strong> Dinh used Adam optimizer with a learning rate $0.001$ and batch size of 256. In my experiments, I observed that increasing the batch size from $256$ to $2048$ consistently yielded better log-likelihoods.</p></li><li><p><strong>Clip the outputs during generating data:</strong> MNIST data is rescaled to the range $[0, 1]$ for training. But during inference, the output may not be always in $[0, 1]$. Therefore, we apply clipping on the generated outputs to bring them to the desired range.</p></li></ul></div><div class=share-section><h4 class=share-title>Share this post</h4><div class=share-buttons><a class="share-btn share-facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fdeepakbaby.in%2fposts%2fnice-keras%2f" target=_blank rel=noopener aria-label="Share on Facebook"><i class="fab fa-facebook-f"></i>
</a><a class="share-btn share-twitter" href="https://twitter.com/share?url=https%3a%2f%2fdeepakbaby.in%2fposts%2fnice-keras%2f&text=NICE-%20Non-linear%20Independent%20Components%20Estimation%3a%20Insights%20and%20Implementation%20in%20Keras" target=_blank rel=noopener aria-label="Share on Twitter"><i class="fab fa-twitter"></i>
</a><a class="share-btn share-linkedin" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fdeepakbaby.in%2fposts%2fnice-keras%2f&title=NICE-%20Non-linear%20Independent%20Components%20Estimation%3a%20Insights%20and%20Implementation%20in%20Keras" target=_blank rel=noopener aria-label="Share on LinkedIn"><i class="fab fa-linkedin-in"></i>
</a><a class="share-btn share-reddit" href="https://reddit.com/submit?url=https%3a%2f%2fdeepakbaby.in%2fposts%2fnice-keras%2f&title=NICE-%20Non-linear%20Independent%20Components%20Estimation%3a%20Insights%20and%20Implementation%20in%20Keras" target=_blank rel=noopener aria-label="Share on Reddit"><i class="fab fa-reddit-alien"></i>
</a><a class="share-btn share-whatsapp" href="https://api.whatsapp.com/send?text=NICE-%20Non-linear%20Independent%20Components%20Estimation%3a%20Insights%20and%20Implementation%20in%20Keras https%3a%2f%2fdeepakbaby.in%2fposts%2fnice-keras%2f" target=_blank rel=noopener aria-label="Share on WhatsApp"><i class="fab fa-whatsapp"></i>
</a><a class="share-btn share-email" href="mailto:?subject=NICE-%20Non-linear%20Independent%20Components%20Estimation%3a%20Insights%20and%20Implementation%20in%20Keras&body=https%3a%2f%2fdeepakbaby.in%2fposts%2fnice-keras%2f" aria-label="Share via Email"><i class="fas fa-envelope"></i></a></div></div><div class=improve-page-section><a href=https://github.com/deepakbaby/deepakbaby-site/edit/main/content/posts/nice-keras/index.md class=improve-link target=_blank rel=noopener><i class="fas fa-code-branch"></i>
<span>Improve this page</span></a></div><nav class=post-navigation><a href=/posts/vae-insights/ class="nav-card nav-prev"><span class=nav-label>← Previous</span>
<span class=nav-title>Implementing Variational Autoencoders: Insights and some tricks</span>
</a><a href=/posts/distributed-training/ class="nav-card nav-next"><span class=nav-label>Next →</span>
<span class=nav-title>Distributed Training Techniques: DDP, Pipeline Parallelism, and FSDP</span></a></nav><div class=comments-section><h2 class=comments-heading><i class="fas fa-comments"></i>
Discussion</h2><div class=comments-content><div id=comments-container><script src=https://utteranc.es/client.js repo=deepakbaby/deepakbaby-site issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></div></article></div></div><button id=scroll-to-top class=scroll-top-btn aria-label="Scroll to top">
<i class="fas fa-chevron-up"></i></button></div><style>@import 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap';.modern-post-wrapper{font-family:inter,-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;padding-top:5rem;width:100vw;max-width:100vw;overflow-x:hidden;margin:0;padding-left:0;padding-right:0}.post-hero-section{position:relative;min-height:60vh;display:flex;align-items:center;justify-content:center;text-align:center;padding:4rem 2rem;overflow:hidden;background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%)}[data-theme=light] .post-hero-section{background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%)}.post-hero-image{position:absolute;inset:0;background-size:cover;background-position:50%;opacity:.15;z-index:0}[data-theme=light] .post-hero-image{opacity:.08}.post-hero-overlay{position:absolute;inset:0;background:radial-gradient(circle at 30% 50%,rgba(59,130,246,.1) 0%,transparent 50%),radial-gradient(circle at 70% 50%,rgba(139,92,246,.1) 0%,transparent 50%);z-index:1}.post-hero-content{position:relative;z-index:2;max-width:900px;margin:0 auto}.post-meta-badges{margin-bottom:1.5rem}.post-category-badge{display:inline-block;padding:.5rem 1.25rem;background:rgba(59,130,246,.15);border:1px solid rgba(59,130,246,.3);border-radius:50px;color:#60a5fa;font-size:.85rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em}[data-theme=light] .post-category-badge{background:rgba(59,130,246,.1);color:#3b82f6}.post-title{font-size:clamp(2rem,5vw,3.5rem);font-weight:400;line-height:1.1;margin:0 0 2rem;color:#fff;letter-spacing:-.02em}[data-theme=light] .post-title{color:#1e293b}.post-meta-info{display:flex;align-items:center;justify-content:center;gap:1.5rem;flex-wrap:wrap;margin-bottom:1.5rem;color:rgba(255,255,255,.8);font-size:.95rem}[data-theme=light] .post-meta-info{color:#64748b}.post-author{display:flex;align-items:center;gap:.75rem}.author-name{font-weight:600}.post-date-time{display:flex;align-items:center;gap:.5rem;color:rgba(255,255,255,.8)}[data-theme=light] .post-date-time{color:rgba(0,0,0,.7)}.post-date-time svg{width:16px;height:16px;opacity:.7}.meta-separator{opacity:.5}.post-tags-hero{display:flex;align-items:center;justify-content:center;gap:.75rem;flex-wrap:wrap}.tag-link{padding:.375rem 1rem;background:rgba(255,255,255,5%);border:1px solid rgba(255,255,255,.1);border-radius:50px;color:rgba(255,255,255,.8);font-size:.85rem;font-weight:500;text-decoration:none;transition:all .3s}.tag-link:hover{background:rgba(59,130,246,.2);border-color:rgba(59,130,246,.4);color:#60a5fa}[data-theme=light] .tag-link{background:rgba(0,0,0,4%);border-color:rgba(0,0,0,8%);color:#64748b}[data-theme=light] .tag-link:hover{background:rgba(59,130,246,.1);border-color:rgba(59,130,246,.3);color:#3b82f6}.post-content-container{max-width:1400px;margin:0 auto;padding:4rem 2rem}.post-content-grid{display:grid;grid-template-columns:1fr;gap:4rem;align-items:start;width:90%;margin:0 auto}.post-article-content{min-width:0}.prose-content{font-family:inter,-apple-system,BlinkMacSystemFont,segoe ui,system-ui,sans-serif;line-height:1.8;font-size:1.0625rem;font-weight:400}.prose-content h1,.prose-content h2,.prose-content h3,.prose-content h4,.prose-content h5,.prose-content h6{font-family:inter,-apple-system,BlinkMacSystemFont,segoe ui,system-ui,sans-serif!important;font-weight:400!important;line-height:1.4!important;margin-top:2.5rem!important;margin-bottom:1rem!important;color:var(--text-primary)!important;letter-spacing:-.01em!important;border:none!important;border-bottom:none!important;border-top:none!important;text-decoration:none!important;box-shadow:none!important;pointer-events:none!important;cursor:text!important}.prose-content h1::before,.prose-content h2::before,.prose-content h3::before,.prose-content h4::before,.prose-content h5::before,.prose-content h6::before,.prose-content h1::after,.prose-content h2::after,.prose-content h3::after,.prose-content h4::after,.prose-content h5::after,.prose-content h6::after{content:none!important;border:none!important;border-bottom:none!important;text-decoration:none!important}.prose-content h1:hover,.prose-content h2:hover,.prose-content h3:hover,.prose-content h4:hover,.prose-content h5:hover,.prose-content h6:hover,.prose-content h1:target,.prose-content h2:target,.prose-content h3:target,.prose-content h4:target,.prose-content h5:target,.prose-content h6:target,.prose-content h1[id],.prose-content h2[id],.prose-content h3[id],.prose-content h4[id],.prose-content h5[id],.prose-content h6[id]{text-decoration:none!important;border-bottom:none!important;cursor:text!important}.prose-content h1{font-size:2.25rem}.prose-content h2{font-size:1.875rem}.prose-content h3{font-size:1.5rem}.prose-content h4{font-size:1.25rem}.prose-content h5{font-size:1.125rem}.prose-content h6{font-size:1rem}.prose-content p{margin-bottom:1.5rem;color:var(--text-primary)}.prose-content a{color:#3b82f6;text-decoration:underline;text-underline-offset:3px;transition:color .2s}.prose-content a:hover{color:#60a5fa}.prose-content ul,.prose-content ol{margin-bottom:1.5rem;padding-left:1.75rem}.prose-content li{margin-bottom:.5rem}.prose-content blockquote{border-left:4px solid #3b82f6;padding-left:1.5rem;margin:1.5rem 0;font-style:italic;color:var(--text-secondary)}.prose-content code{background:rgba(59,130,246,.1);padding:.2em .4em;border-radius:4px;font-size:.9em;font-family:courier new,monospace;color:#3b82f6}[data-theme=light] .prose-content code{background:rgba(59,130,246,8%)}.prose-content pre{background:rgba(0,0,0,.3);padding:1.5rem;border-radius:12px;overflow-x:auto;margin:1.5rem 0;border:1px solid rgba(255,255,255,.1)}[data-theme=light] .prose-content pre{background:#f8fafc;border-color:rgba(0,0,0,8%)}.prose-content pre code{background:0 0;padding:0;color:inherit}.prose-content img{max-width:100%;height:auto;border-radius:12px;margin:2rem 0}.prose-content table{width:100%;border-collapse:collapse;margin:1.5rem 0}.prose-content th,.prose-content td{border:1px solid rgba(255,255,255,.1);padding:.75rem;text-align:left}[data-theme=light] .prose-content th,[data-theme=light] .prose-content td{border-color:rgba(0,0,0,8%)}.prose-content th{background:rgba(59,130,246,.1);font-weight:600}.prose-content hr{border:none;border-top:1px solid rgba(255,255,255,.1);margin:3rem 0}[data-theme=light] .prose-content hr{border-top-color:rgba(0,0,0,8%)}.prose-content .katex{font-size:1.1em}.prose-content .katex-display{overflow-x:auto;overflow-y:hidden;padding:1rem 0}.share-section{margin-top:4rem;padding-top:2rem;border-top:1px solid rgba(255,255,255,.1)}[data-theme=light] .share-section{border-top-color:rgba(0,0,0,8%)}.share-title{font-size:1.125rem;font-weight:600;margin-bottom:1rem;color:var(--text-primary)}.share-buttons{display:flex;gap:.75rem;flex-wrap:wrap}.share-btn{display:flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,5%);border:1px solid rgba(255,255,255,.1);color:var(--text-secondary);text-decoration:none;transition:all .3s}.share-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2)}.share-facebook:hover{background:#1877f2;border-color:#1877f2;color:#fff}.share-twitter:hover{background:#1da1f2;border-color:#1da1f2;color:#fff}.share-linkedin:hover{background:#0a66c2;border-color:#0a66c2;color:#fff}.share-reddit:hover{background:#ff4500;border-color:#ff4500;color:#fff}.share-whatsapp:hover{background:#25d366;border-color:#25d366;color:#fff}.share-email:hover{background:#6b7280;border-color:#6b7280;color:#fff}.improve-page-section{margin-top:3rem;text-align:center}.improve-link{display:inline-flex;align-items:center;gap:.5rem;padding:.75rem 1.5rem;background:rgba(255,255,255,5%);border:1px solid rgba(255,255,255,.1);border-radius:50px;color:var(--text-secondary);text-decoration:none;font-weight:500;transition:all .3s}.improve-link:hover{background:rgba(59,130,246,.1);border-color:rgba(59,130,246,.3);color:#3b82f6}.post-navigation{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-top:4rem}.nav-card{padding:1.5rem;background:rgba(255,255,255,3%);border:1px solid rgba(255,255,255,8%);border-radius:12px;text-decoration:none;transition:all .3s;display:flex;flex-direction:column;gap:.5rem}[data-theme=light] .nav-card{background:rgba(255,255,255,.6);border-color:rgba(0,0,0,8%)}.nav-card:hover{border-color:rgba(59,130,246,.3);transform:translateY(-2px);box-shadow:0 8px 20px rgba(59,130,246,.1)}.nav-label{font-size:.875rem;color:var(--text-muted);font-weight:500}.nav-title{font-size:1.125rem;font-weight:600;color:var(--text-primary)}.comments-section{margin-top:5rem;padding-top:3rem;border-top:2px solid rgba(255,255,255,.1)}[data-theme=light] .comments-section{border-top-color:rgba(0,0,0,8%)}.comments-heading{font-size:1.75rem;font-weight:700;margin-bottom:2rem;color:var(--text-primary);display:flex;align-items:center;gap:.75rem}.comments-heading i{color:#3b82f6}.scroll-top-btn{position:fixed;bottom:2rem;right:2rem;width:50px;height:50px;border-radius:50%;background:rgba(59,130,246,.9);border:none;color:#fff;font-size:1.25rem;cursor:pointer;opacity:0;visibility:hidden;transition:all .3s;box-shadow:0 4px 12px rgba(59,130,246,.3);z-index:100}.scroll-top-btn.visible{opacity:1;visibility:visible}.scroll-top-btn:hover{background:#3b82f6;transform:translateY(-4px);box-shadow:0 8px 20px rgba(59,130,246,.4)}@media(max-width:768px){.modern-post-wrapper{padding-top:4rem}.post-hero-section{min-height:50vh;padding:3rem 1.5rem}.post-title{font-size:2rem}.post-meta-info{flex-direction:column;gap:1rem}.post-content-container{padding:2rem 1.5rem}.post-content-grid{width:90%}.prose-content{font-size:1rem}.prose-content h1{font-size:1.875rem}.prose-content h2{font-size:1.5rem}.prose-content h3{font-size:1.25rem}.scroll-top-btn{bottom:1.5rem;right:1.5rem;width:44px;height:44px}}</style><script>(function(){"use strict";const e=document.getElementById("scroll-to-top");window.addEventListener("scroll",()=>{window.pageYOffset>300?e.classList.add("visible"):e.classList.remove("visible")}),e.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})})})()</script></div><footer class=modern-footer><div class=footer-glow></div><div class=footer-container><div class=footer-content><div class=footer-brand><span class=brand-name>Deepak Baby</span><p class=brand-tagline>Senior Data Scientist at KBC Bank & Verzekering</p></div><div class=footer-social><a href=mailto:deepakbabycet@gmail.com class=social-icon aria-label=Email title=Email><i class="fas fa-envelope"></i>
</a><a href=https://www.github.com/deepakbaby class=social-icon target=_blank rel="noopener noreferrer" aria-label=Github title=Github><i class="fab fa-github"></i>
</a><a href=https://www.linkedin.com/in/deepakbaby/ class=social-icon target=_blank rel="noopener noreferrer" aria-label=LinkedIn title=LinkedIn><i class="fab fa-linkedin"></i>
</a><a href="https://scholar.google.com/citations?user=69q7FOYAAAAJ&amp;hl=en" class=social-icon target=_blank rel="noopener noreferrer" aria-label="Google Scholar" title="Google Scholar"><i class="fa-brands fa-google-scholar"></i></a></div><div class=footer-links><a href=#hero>Home</a>
<a href=#about>About</a>
<a href=#experiences>Experience</a>
<a href=#posts>Blog</a>
<a href=#publications>Publications</a></div></div><div class=footer-bottom><p class=copyright>© 2025 Deepak Baby. All rights reserved.</p><p class=credits>Made with <span class=heart>❤</span>, Hugo and Claude</p></div></div></footer><style>.modern-footer{position:relative;background:#050506;padding:4rem 0 2rem;overflow:hidden}.footer-glow{position:absolute;top:0;left:50%;transform:translateX(-50%);width:600px;height:2px;background:linear-gradient(90deg,transparent 0%,#3b82f6 25%,#1d4ed8 50%,#3b82f6 75%,transparent 100%);filter:blur(1px)}.footer-container{max-width:1200px;margin:0 auto;padding:0 2rem}.footer-content{display:flex;flex-direction:column;align-items:center;text-align:center;gap:2rem;margin-bottom:3rem}.footer-brand{margin-bottom:.5rem}.brand-name{font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,#fff 0%,#a78bfa 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.brand-tagline{font-size:.9rem;color:#6b7280;margin:.5rem 0 0}.footer-social{display:flex;gap:1rem}.social-icon{width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,5%);border:1px solid rgba(255,255,255,8%);display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:1.1rem;text-decoration:none;transition:all .3s ease}.social-icon:hover{background:linear-gradient(135deg,#8b5cf6 0%,#3b82f6 100%);border-color:transparent;color:#fff;transform:translateY(-4px);box-shadow:0 8px 25px rgba(139,92,246,.3)}.footer-links{display:flex;flex-wrap:wrap;justify-content:center;gap:1.5rem}.footer-links a{color:#6b7280;text-decoration:none;font-size:.9rem;transition:color .3s}.footer-links a:hover{color:#a78bfa}.footer-bottom{border-top:1px solid rgba(255,255,255,5%);padding-top:2rem;display:flex;flex-direction:column;align-items:center;gap:.5rem}.copyright{font-size:.875rem;color:#4b5563;margin:0}.credits{font-size:.75rem;color:#374151;margin:0}.heart{color:#ef4444;animation:heartbeat 1.5s infinite}@keyframes heartbeat{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}@media(min-width:768px){.footer-content{flex-direction:row;justify-content:space-between;text-align:left}.footer-bottom{flex-direction:row;justify-content:space-between}}</style><script src=/application.f6959e0d840b2a0cb8ebdc7b64f82c76ed540bafda2e2f31ece1d91e812ba4d1.js integrity="sha256-9pWeDYQLKgy469x7ZPgsdu1UC6/aLi8x7OHZHoErpNE=" defer></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}],throwOnError:!1,strict:!1})'></script><script src=/js/collapsible-sidebars.js></script></body></html>