<!doctype html><html lang=en><head><title>Training kaldi models with custom features</title><style>:root{--bg-primary:#0f172a;--bg-secondary:#1e293b;--bg-card:rgba(255, 255, 255, 0.03);--text-primary:#fff;--text-secondary:#9ca3af;--text-muted:#6b7280;--border-color:rgba(255, 255, 255, 0.08);--orb-opacity:0.5;--toggle-bg:rgba(255, 255, 255, 0.1);--toggle-border:rgba(255, 255, 255, 0.2);--social-bg:rgba(255, 255, 255, 0.05);--social-border:rgba(255, 255, 255, 0.1);--mouse-border:rgba(255, 255, 255, 0.2);--wheel-bg:rgba(255, 255, 255, 0.4);--card-hover-border:rgba(59, 130, 246, 0.3);--card-hover-shadow:rgba(59, 130, 246, 0.15)}[data-theme=light]{--bg-primary:#fafbfc;--bg-secondary:#ffffff;--bg-card:transparent;--text-primary:#1e293b;--text-secondary:#475569;--text-muted:#94a3b8;--border-color:rgba(0, 0, 0, 0.06);--orb-opacity:0.1;--toggle-bg:rgba(0, 0, 0, 0.04);--toggle-border:rgba(0, 0, 0, 0.08);--social-bg:transparent;--social-border:rgba(0, 0, 0, 0.1);--mouse-border:rgba(0, 0, 0, 0.12);--wheel-bg:rgba(0, 0, 0, 0.2);--card-hover-border:rgba(59, 130, 246, 0.3);--card-hover-shadow:rgba(59, 130, 246, 0.08);--card-bg:transparent;--card-border:rgba(0, 0, 0, 0.04);--timeline-color:#3b82f6;--section-bg:#ffffff;--glow-color:rgba(59, 130, 246, 0.08)}body{background-color:var(--bg-primary);color:var(--text-primary)}</style><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.c783c6e6b679af484325eb2b13483dfca8aa9b848c0b6e81bd4022ece7a9a0ef.css integrity="sha256-x4PG5rZ5r0hDJesrE0g9/Kiqm4SMC26BvUAi7OepoO8="><link rel=icon type=image/png href=/images/site/favicon_hu_be34366aac4a405.png><meta property="og:title" content="Deepak Baby"><meta property="og:type" content="website"><meta property="og:description" content="Personal website of Deepak Baby."><meta property="og:image" content="/images/author/deepak.jpeg"><meta property="og:url" content="https://deepakbaby.in"><meta name=description content="Training kaldi models with custom features"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><link rel=stylesheet href=/css/collapsible-sidebars.css><link rel=stylesheet href=/css/comments.css><script integrity="sha256-DO4ugzEwhTW1Id1UIWn0gUJWaebCYOypeTit6LW4QB4=">let theme=localStorage.getItem("theme-scheme")||localStorage.getItem("darkmode:color-scheme")||"light";theme==="system"&&(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?theme="dark":theme="light"),document.documentElement.setAttribute("data-theme",theme)</script></head><body class="type-posts kind-page" data-bs-spy=scroll data-bs-target=#TableOfContents data-bs-offset=80><div class="container-fluid wrapper"><button class=theme-toggle-fixed id=themeToggle aria-label="Toggle theme"><svg class="sun-icon" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364-.707-.707M6.343 6.343l-.707-.707m12.728.0-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><svg class="moon-icon" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003.0 0012 21a9.003 9.003.0 008.354-5.646z"/></svg></button><nav class=scroll-navbar id=scrollNavbar><div class=navbar-container><a href=https://deepakbaby.in/ class=navbar-brand><img src=/images/site/favicon.png alt class=navbar-favicon>
Deepak Baby</a><div class=navbar-links><a href=https://deepakbaby.in/#about class=navbar-link>About</a>
<a href=https://deepakbaby.in/#experiences class=navbar-link>Experience</a>
<a href=/posts class=navbar-link>Blog</a>
<a href=https://deepakbaby.in/publications class=navbar-link>Publications</a></div><button class=theme-toggle-navbar id=themeToggleNav aria-label="Toggle theme"><svg class="sun-icon" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364-.707-.707M6.343 6.343l-.707-.707m12.728.0-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><svg class="moon-icon" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003.0 0012 21a9.003 9.003.0 008.354-5.646z"/></svg></button></div></nav><style>.theme-toggle-fixed{position:fixed;top:1.5rem;right:1.5rem;width:44px;height:44px;border-radius:50%;background:var(--toggle-bg,rgba(255,255,255,.1));border:1px solid var(--toggle-border,rgba(255,255,255,.2));display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;color:var(--text-primary,#fff);z-index:1000}.theme-toggle-fixed:hover{background:var(--toggle-hover-bg,rgba(255,255,255,.2));transform:scale(1.05)}.theme-toggle-fixed svg{width:22px;height:22px}.scroll-navbar.visible~.theme-toggle-fixed,.theme-toggle-fixed.hidden{opacity:0;pointer-events:none}.scroll-navbar.visible~.section-wrapper .theme-toggle-fixed,body:has(.scroll-navbar.visible) .theme-toggle-fixed{opacity:0;pointer-events:none}.scroll-navbar{position:fixed;top:0;left:0;right:0;background:var(--navbar-bg,rgba(15,23,42,.95));backdrop-filter:blur(20px);border-bottom:1px solid var(--border-color,rgba(255,255,255,8%));z-index:999;transform:translateY(-100%);transition:transform .3s ease}.scroll-navbar.visible{transform:translateY(0)}.navbar-container{max-width:1200px;margin:0 auto;padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between}.navbar-brand{display:flex;align-items:center;gap:.75rem;font-family:inter,sans-serif;font-size:1.125rem;font-weight:500;color:var(--text-primary,#fff);text-decoration:none!important;transition:transform .3s ease,color .3s}.navbar-brand:hover,.navbar-brand:focus,.navbar-brand:active{transform:translateY(-2px);color:#3b82f6;text-decoration:none!important}.navbar-favicon{width:28px;height:28px;border-radius:6px}.navbar-links{display:flex;gap:2rem}.navbar-link{font-family:inter,sans-serif;font-size:.875rem;font-weight:400;color:var(--text-secondary,rgba(255,255,255,.7));text-decoration:none!important;transition:transform .3s ease,color .3s;display:inline-block}.navbar-link:hover,.navbar-link:focus,.navbar-link:active{transform:translateY(-2px);color:var(--text-primary,#fff);text-decoration:none!important}.theme-toggle-navbar{width:36px;height:36px;border-radius:50%;background:var(--toggle-bg,rgba(255,255,255,.1));border:1px solid var(--toggle-border,rgba(255,255,255,.2));display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;color:var(--text-primary,#fff)}.theme-toggle-navbar:hover{background:var(--toggle-hover-bg,rgba(255,255,255,.2))}.theme-toggle-navbar svg{width:18px;height:18px}.sun-icon{display:none}.moon-icon{display:block}[data-theme=light] .sun-icon{display:block}[data-theme=light] .moon-icon{display:none}[data-theme=light] .scroll-navbar{--navbar-bg:rgba(255, 255, 255, 0.98);box-shadow:0 1px 8px rgba(0,0,0,5%);border-bottom-color:transparent}@media(max-width:768px){.theme-toggle-fixed{top:1rem;right:1rem;width:40px;height:40px}.navbar-links{display:none}}</style><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("themeToggle"),a=document.getElementById("themeToggleNav"),t=document.getElementById("scrollNavbar"),n=document.documentElement,r=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark");n.setAttribute("data-theme",r);function s(){const t=n.getAttribute("data-theme"),e=t==="dark"?"light":"dark";n.setAttribute("data-theme",e),localStorage.setItem("theme",e)}e?.addEventListener("click",s),a?.addEventListener("click",s);const o=document.querySelector(".hero-section"),i=o?o.offsetHeight*.6:100;window.addEventListener("scroll",()=>{const n=window.pageYOffset;n>i?(t?.classList.add("visible"),e?.classList.add("hidden")):(t?.classList.remove("visible"),e?.classList.remove("hidden"))}),window.pageYOffset>i&&(t?.classList.add("visible"),e?.classList.add("hidden"))})</script><style>.type-posts .container-fluid.wrapper{max-width:none!important;width:100%!important;padding:0!important;margin:0!important;overflow-x:hidden!important}body.type-posts{overflow-x:hidden!important;width:100vw!important;max-width:100vw!important}html{overflow-x:hidden!important}</style><div class=modern-post-wrapper><section class=post-hero-section><div class=post-hero-overlay></div><div class=post-hero-image style=background-image:url(/images/default-hero.jpg)></div><div class=post-hero-content><div class=post-meta-badges><span class=post-category-badge>kaldi</span></div><h1 class=post-title>Training kaldi models with custom features</h1><div class=post-meta-info><div class=post-author><span class=author-name>Deepak Baby</span></div><div class=post-date-time><svg width="16" height="16" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5A2 2 0 003 7v12a2 2 0 002 2z"/></svg>
<span>Wednesday, March 6, 2019</span>
<span class=meta-separator>•</span>
<svg width="16" height="16" fill="none" stroke="currentcolor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3A9 9 0 113 12a9 9 0 0118 0z"/></svg>
<span>10 min read</span></div></div><div class=post-tags-hero><a href=/tags/kaldi class=tag-link>#kaldi</a>
<a href=/tags/matlab class=tag-link>#matlab</a>
<a href=/tags/python class=tag-link>#python</a></div></div></section><div class=post-content-container><div class=post-content-grid><article class=post-article-content><div class=prose-content id=post-content><p><a href=https://github.com/kaldi-asr/kaldi>Kaldi Speech Recognition Toolkit</a> is a freely available toolkit that offers several tools for conducting research on automatic speech recognition (ASR). It lets us train an ASR system from scratch all the way from the feature extraction (MFCC,FBANK, ivector, FMLLR,&mldr;), GMM and DNN acoustic model training, to the decoding using advanced language models, and produce state-of-the-art results.</p><p>While kaldi offers so much flexibilty at every stage, sometimes we also need to play with features that are not offered by the kaldi repository. Kaldi makes use of ark format to store the features. If we want to perform experiments with customized features, they must be converted to the ark format first. The goal of this post is to explain how we can extract and store the custom features in the ark format using matlab and python.</p><ul><li><a href=/posts/kaldi-custom-features/#first-steps>First steps</a></li><li><a href=/posts/kaldi-custom-features/#custom-features-using-matlab>Custom features using MATLAB</a></li><li><a href=/posts/kaldi-custom-features/#custom-features-using-python>Custom features using Python</a></li></ul><hr><h2 id=first-steps>First Steps</h2><p>In this tutorial, we will be starting with a <code>data</code> folder that is generated by kaldi, in order to avoid directory validation errors (which is performed by kaldi before training any model). So we we will run the kaldi routine to prepare the data folders (typically done by <code>local/&lt;datasetname>_data_prep.sh</code> script). This will generate all the required files such as <code>text</code> containing the transcriptions, <code>utt2spk</code> and <code>spk2utt</code> for CMVN and ivector computation, and <code>wav.scp</code> for reading the audio files from the disk. Then we will run the feature extraction pipeline in the default kaldi way, say FBANK features. Typically, the <code>data-fbank</code> folder contains the <code>train</code>, <code>test</code> and <code>dev</code> folder along with the <code>text</code>, <code>utt2spk</code>, <code>spk2utt</code> and <code>wav.scp</code> files.</p><p>Running the <code>make_fbank_feats.sh</code> will typically store the features in the ark format to the <code>fbank</code> folder and the corresponding <code>feats.scp</code> files (used for reading the ark files) will be placed in the respective subfolder in <code>data-fbank</code>. In order to run the feature extraction in parallel, kaldi typically splits the data into 10 sets and extract them in parallel. Thus the directory structure will typically be:</p><pre tabindex=0><code>fbank
├── raw_fbank_dev.1.ark
├── raw_fbank_dev.1.scp
├── ...
├── ...
├── raw_fbank_dev.10.ark
├── raw_fbank_dev.10.scp
├── raw_fbank_test.1.ark
├── raw_fbank_test.1.scp
├── ...
├── ...
├── raw_fbank_test.10.ark
├── raw_fbank_test.10.scp
├── raw_fbank_train.1.ark
├── raw_fbank_train.1.scp
├── ...
├── ...
├── raw_fbank_train.10.ark
└── raw_fbank_train.10.scp

data-fbank
├── dev
│   ├── feats.scp
│   ├── spk2gender
│   ├── spk2utt
│   ├── stm
│   ├── text
│   ├── utt2spk
│   ├── wav.scp
│   └── split10
|
├── test
│   ├── feats.scp
│   ├── spk2gender
│   ├── spk2utt
│   ├── text
│   ├── utt2spk
│   ├── wav.scp
│   └─ split10
|
├── train
    ├── feats.scp
    ├── spk2gender
    ├── spk2utt
    ├── split10
    ├── text
    ├── train
    ├── utt2spk
    └── wav.scp
</code></pre><p>To summarize the steps so far:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># run the data preparation</span>
</span></span><span style=display:flex><span>bash local/&lt;database&gt;_data_prep.sh 
</span></span><span style=display:flex><span><span style=color:#75715e># extract fbank features</span>
</span></span><span style=display:flex><span>mkdir fbank data-fbank
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> x in train test dev ; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    cp -r data/$x data-fbank/
</span></span><span style=display:flex><span>    steps/make_fbank.sh --nj <span style=color:#ae81ff>10</span>  --fbank-config conf/fbank.sh <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      data-fbank/$x exp/make_fbank/$x fbank <span style=color:#f92672>||</span> exit 1;
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>Notice that <code>feats.scp</code> is a concatenation of all the <code>.scp</code> files belonging to the subset (train, dev or test). <code>.scp</code> files will have two columns: the first column contains the unique id for the utterance and the second column says where the corresponding features are located in the ark file. This tutorial will manipulate the ark files and scp files in order that they are to be used by kaldi for training.</p><p>The the next step is to create <code>myfeats</code> and <code>data-myfeats</code> directories. These directories will follow the same structure as used by the <code>fbank</code> and <code>data-fbank</code> directories, but contains our custom features inside. Noice that the data folder will have the same files except the <code>feats.scp</code>. <code>feats.scp</code> has to be modified such that it tells kaldi to read features from the <code>myfeats</code> folder. The steps are summarized below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkdir myfeats data-myfeats     
</span></span><span style=display:flex><span>$ cp -r data-fbank/* data-myfeats       
</span></span><span style=display:flex><span>$ rm data-myfeats/*/feats.scp  <span style=color:#75715e># we will need to generate new feats.scp files for the custom feats</span>
</span></span></code></pre></div><p>Now the pre-requisites are done. Next, we can use either MATLAB or python to prepare the custom features and generate the correspoding ark and scp files.</p><p><a href=/posts/kaldi-custom-features/#custom-features-using-python>Click here to jump to the python approach</a></p><blockquote><p><strong>Warning:</strong> Notice that if you want to use the alignments obtained using say MFCC features, the number of frames in the new features should match that of the MFCC features. i.e., the custom feature extraction must use the same window size and window shift. Otherwise, we will end up with wrong alignments and the (DNN or GMM) training will fail.</p></blockquote><hr><h2 id=custom-features-using-matlab>Custom features using MATLAB</h2><p>Since kaldi makes use of a unique ID to read the ark files, we will need to follow the same format. As mentioned before, we will use the already prepared FBANK features as a reference file to generate our custom features. In order to do this with MATLAB, we will need to read and write the ark files using MATLAB.</p><p>The research page of <a href=http://www.utdallas.edu/~hxb076000/>Hynek Boril</a> offers matlab routines for reading and writing ark files. The codes can be found <a href=http://www.utdallas.edu/~hynek/tools/Kaldi/>here</a>. It offers three MATLAB files:</p><ol><li><a href=http://www.utdallas.edu/~hynek/tools/Kaldi/arkread.m>arkread.m</a> : For reading ark files</li><li><a href=http://www.utdallas.edu/~hynek/tools/Kaldi/arkwrite.m>arkwrite.m</a> : For writing ark files</li><li><a href=http://www.utdallas.edu/~hynek/tools/Kaldi/ark2scp.m>ark2scp.m</a> : For generating scp files from ark files</li></ol><p>So the general procedure is follows: Use <code>arkread.m</code> to read the ark files which will return a header mat and a feature matrix. The header mat contains the unique id of the utterance and the feature size related information. feature mat is a huge matrix that contains all the feature vectors. The idea is to change the feature mat with our custom features, change header mat accordingly and to write it using <code>arkwrite.m</code>. Then we will use <code>ark2scp.m</code> to generate the corresponding <code>.scp</code> file.</p><p>A sample MATLAB code is given below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-MATLAB data-lang=MATLAB><span style=display:flex><span>
</span></span><span style=display:flex><span>setlist = {<span style=color:#e6db74>&#39;test&#39;</span>, <span style=color:#e6db74>&#39;train&#39;</span>, <span style=color:#e6db74>&#39;dev&#39;</span>}
</span></span><span style=display:flex><span>myfeatname = <span style=color:#e6db74>&#39;myfeats&#39;</span>;
</span></span><span style=display:flex><span>splits = <span style=color:#ae81ff>10</span>; <span style=color:#75715e>% the feature extraction is typically split into 10, change this otherwise</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fbankdatadir = fullfile(codedir, <span style=color:#e6db74>&#39;data-fbank&#39;</span>);
</span></span><span style=display:flex><span>fbankfeatdir = fullfile(codedir, <span style=color:#e6db74>&#39;fbank&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>datadir = fullfile(codedir, [<span style=color:#e6db74>&#39;data-&#39;</span>, myfeatname]);
</span></span><span style=display:flex><span>featdir = fullfile(codedir, myfeatname);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>% create dirs</span>
</span></span><span style=display:flex><span>system([<span style=color:#e6db74>&#39;mkdir -p &#39;</span> datadir <span style=color:#e6db74>&#39; &#39;</span> featdir])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> setnum = <span style=color:#ae81ff>1</span>:length(setlist)
</span></span><span style=display:flex><span>    setname = setlist{setnum};
</span></span><span style=display:flex><span>    <span style=color:#75715e>% copy files</span>
</span></span><span style=display:flex><span>    system([<span style=color:#e6db74>&#39;cp -r &#39;</span> fbankdatadir <span style=color:#e6db74>&#39;/&#39;</span> setname <span style=color:#e6db74>&#39;  &#39;</span> datadir <span style=color:#e6db74>&#39;/&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    filelist = fullfile(datadir, setname, <span style=color:#e6db74>&#39;wav.scp&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    fid = fopen(filelist, <span style=color:#e6db74>&#39;r&#39;</span>);
</span></span><span style=display:flex><span>    filenames = textscan (fid, <span style=color:#e6db74>&#39;%s %s&#39;</span>);
</span></span><span style=display:flex><span>    fclose(fid);
</span></span><span style=display:flex><span>    numfiles = length(filenames{<span style=color:#ae81ff>1</span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    fileindex = <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> splitindex = <span style=color:#ae81ff>1</span>: splits
</span></span><span style=display:flex><span>        disp ([<span style=color:#e6db74>&#39;Processing &#39;</span> num2str(splitindex) <span style=color:#e6db74>&#39; of &#39;</span> num2str(splits) <span style=color:#e6db74>&#39; split data.&#39;</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        srcark = strcat(<span style=color:#e6db74>&#39;raw_fbank_&#39;</span>, dtag, <span style=color:#e6db74>&#39;.&#39;</span>, num2str(splitindex), <span style=color:#e6db74>&#39;.ark&#39;</span>);
</span></span><span style=display:flex><span>        srcark_filename = fullfile(fbankfeatdir, srcark);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        destark = strcat(<span style=color:#e6db74>&#39;raw_&#39;</span>, myfeatname, <span style=color:#e6db74>&#39;_&#39;</span>, setname, <span style=color:#e6db74>&#39;.&#39;</span>, num2str(splitindex), <span style=color:#e6db74>&#39;.ark&#39;</span>);
</span></span><span style=display:flex><span>        destscp = strcat(<span style=color:#e6db74>&#39;raw_&#39;</span>, myfeatname, <span style=color:#e6db74>&#39;_&#39;</span>, setname, <span style=color:#e6db74>&#39;.&#39;</span>, num2str(splitindex), <span style=color:#e6db74>&#39;.scp&#39;</span>);
</span></span><span style=display:flex><span>        destark_filename = fullfile(featdir, destark);
</span></span><span style=display:flex><span>	destscp_filename = fullfile(featdir, destscp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        [HEADER_MAT, FEATURE_MAT] = arkread(srcark_filename);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        HEADER_MAT_NEW = cell(size(HEADER_MAT,<span style=color:#ae81ff>1</span>), <span style=color:#ae81ff>5</span>);
</span></span><span style=display:flex><span>        FEATURE_MAT_NEW = zeros(size(FEATURE_MAT,<span style=color:#ae81ff>1</span>), featdim); <span style=color:#75715e>% expects same frame dimension as FBANK</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        framestart = <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> lt(splitindex, splitstart)
</span></span><span style=display:flex><span>            fileindex = fileindex <span style=color:#f92672>+</span> size(HEADER_MAT, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> filenum = <span style=color:#ae81ff>1</span> : size(HEADER_MAT, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            disp([<span style=color:#e6db74>&#39;File index is &#39;</span> num2str(fileindex) <span style=color:#e6db74>&#39; of split set &#39;</span> num2str(splitindex)])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>% verify the id</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>~</span>strcmp(HEADER_MAT{filenum,<span style=color:#ae81ff>1</span>}, filenames{<span style=color:#ae81ff>1</span>}(fileindex))
</span></span><span style=display:flex><span>                error (<span style=color:#e6db74>&#39;ID mismatch!&#39;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>	    <span style=color:#75715e>% read the audio file, the filename is typically the second column in wav.scp</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e>% else, find the right column index in wav.scp and change the cell column below</span>
</span></span><span style=display:flex><span>	    [x, fs] = audioread(char(filenames{<span style=color:#ae81ff>2</span>}(fileindex)));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e>% Extract custom features here</span>
</span></span><span style=display:flex><span>	    newfeat = extract_my_feats(x);
</span></span><span style=display:flex><span>            <span style=color:#75715e>% expected shape of newfeat is (numframes x featdim)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>	    <span style=color:#75715e>% check if it has the same number frames as in FBANK</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e>% else, it is an error if we need to reuse alignments</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e>% if you dont need to use existing alignmnents</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e>% comment out this check</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ne(HEADER_MAT{filenum,<span style=color:#ae81ff>2</span>}, size(newfeat,<span style=color:#ae81ff>1</span>));
</span></span><span style=display:flex><span>                error (<span style=color:#e6db74>&#39;Dimension mismtach!&#39;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            frameend = framestart <span style=color:#f92672>+</span> size(newfeat,<span style=color:#ae81ff>1</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>            <span style=color:#75715e>% fill in header mat details</span>
</span></span><span style=display:flex><span>            HEADER_MAT_NEW{filenum,<span style=color:#ae81ff>1</span>} = HEADER_MAT{filenum,<span style=color:#ae81ff>1</span>};
</span></span><span style=display:flex><span>            HEADER_MAT_NEW{filenum,<span style=color:#ae81ff>2</span>} = size(newfeat,<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>            HEADER_MAT_NEW{filenum, <span style=color:#ae81ff>3</span>} = featdim;
</span></span><span style=display:flex><span>            HEADER_MAT_NEW{filenum, <span style=color:#ae81ff>4</span>} = framestart;
</span></span><span style=display:flex><span>            HEADER_MAT_NEW{filenum, <span style=color:#ae81ff>5</span>} = frameend;
</span></span><span style=display:flex><span>            <span style=color:#75715e>% add features to featuremat</span>
</span></span><span style=display:flex><span>            FEATURE_MAT_NEW (framestart:frameend,:) = feat;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            fileindex = fileindex <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>            framestart = frameend <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>% write the ark file</span>
</span></span><span style=display:flex><span>        disp (<span style=color:#e6db74>&#39;Writing ark files...&#39;</span>)
</span></span><span style=display:flex><span>        arkwrite(destark_filename, HEADER_MAT_NEW, FEATURE_MAT_NEW);
</span></span><span style=display:flex><span>        ark2scp(destark_filename);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span> <span style=color:#75715e>% splitindex</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span> <span style=color:#75715e>% set num</span>
</span></span></code></pre></div><p>Now the features successfully stored to ark files and the corresponding scp files are generated. We will next have to generate the <code>feats.scp</code> file by concatenating the scp files which are split into 10 subsets. You can do it in a terminal using:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nj<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> x in test train dev; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    rm -f data-myfeats/$x/feats.scp
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> n in <span style=color:#66d9ef>$(</span>seq $nj<span style=color:#66d9ef>)</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      cat $feat/raw_myfeat_<span style=color:#e6db74>${</span>x<span style=color:#e6db74>}</span>.$n.scp <span style=color:#f92672>||</span> exit 1;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span> &gt; data-myfeats/$name/feats.scp
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>Now you can change the data directory in training scripts to <code>data-myfeats</code> to train and decode using kaldi using your custom features.</p><hr><h2 id=custom-features-using-python>Custom features using Python</h2><p>As mentioned in the above section, snce kaldi makes use of a unique ID to read the ark files, we will need to follow the same format. For this we will use the already prepared FBANK features as a reference file to generate our custom features. In order to do this with python, we will need python routines to read and write ark files.</p><p>The <a href=https://github.com/nttcslab-sp/kaldiio>kaldiio</a> is a pure python module for reading and writing kaldi ark files. You can install it to your machine/environment using pip.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>pip install kaldiio
</span></span></code></pre></div><p>We will make use of the <code>load_ark</code> and <code>save_ark</code> commands. So the general procedure is follows: Use <code>load_ark</code> to read the ark files which will return the unique id and the corresponding feature matrix. The idea is to change the feature matrix with our custom features, use it with the unique id and to write it using <code>save_ark</code>. We will also use <code>save_ark</code> to generate the corresponding .scp file.</p><p>A sample python code is given below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> kaldiio
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> numpy <span style=color:#66d9ef>as</span> np
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> shutil
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> scipy <span style=color:#66d9ef>as</span> sp
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> scipy.signal <span style=color:#66d9ef>as</span> sp_sig
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>copy_and_overwrite</span>(from_path, to_path):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(to_path):
</span></span><span style=display:flex><span>        shutil<span style=color:#f92672>.</span>rmtree(to_path)
</span></span><span style=display:flex><span>    shutil<span style=color:#f92672>.</span>copytree(from_path, to_path)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>basedir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getcwd()
</span></span><span style=display:flex><span>setlist <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;test&#39;</span>, <span style=color:#e6db74>&#39;train&#39;</span>, <span style=color:#e6db74>&#39;dev&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>featdim <span style=color:#f92672>=</span> <span style=color:#ae81ff>64</span> <span style=color:#75715e># insert your feature dim here</span>
</span></span><span style=display:flex><span>tags <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;myfeats&#39;</span>
</span></span><span style=display:flex><span>splits <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fbankdatadir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(basedir, <span style=color:#e6db74>&#39;data-fbank&#39;</span>)
</span></span><span style=display:flex><span>fbankfeatdir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join (basedir, <span style=color:#e6db74>&#39;fbank&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>datadir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(basedir, <span style=color:#e6db74>&#39;data-&#39;</span><span style=color:#f92672>+</span> tags)
</span></span><span style=display:flex><span>featdir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(basedir, tags);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># create dirs if they dont exist</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>isdir(datadir):
</span></span><span style=display:flex><span>    os<span style=color:#f92672>.</span>makedirs(datadir)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>isdir(featdir):
</span></span><span style=display:flex><span>    os<span style=color:#f92672>.</span>makedirs(featdir)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> setnum <span style=color:#f92672>in</span> range(len(setlist)):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    setname <span style=color:#f92672>=</span> setlist[setnum];
</span></span><span style=display:flex><span>    print (<span style=color:#e6db74>&#39;Processing &#39;</span> <span style=color:#f92672>+</span> setname <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39; data.&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># copy files</span>
</span></span><span style=display:flex><span>    src_dir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(fbankdatadir, setname)
</span></span><span style=display:flex><span>    dst_dir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(datadir, setname)
</span></span><span style=display:flex><span>    copy_and_overwrite(src_dir, dst_dir)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    filelist <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(datadir, setname, <span style=color:#e6db74>&#39;wav.scp&#39;</span>)
</span></span><span style=display:flex><span>    dtag <span style=color:#f92672>=</span> setname
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    filenames <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    keys_orig <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> open(filelist):
</span></span><span style=display:flex><span>        filenames<span style=color:#f92672>.</span>append(line<span style=color:#f92672>.</span>split()[<span style=color:#ae81ff>4</span>]) <span style=color:#75715e># wavenames is in the 5th column</span>
</span></span><span style=display:flex><span>        keys_orig<span style=color:#f92672>.</span>append(line<span style=color:#f92672>.</span>split()[<span style=color:#ae81ff>0</span>]) <span style=color:#75715e># key or id is in the first column</span>
</span></span><span style=display:flex><span>    numfiles <span style=color:#f92672>=</span> len(filenames)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    fileindex <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> splitindex <span style=color:#f92672>in</span> range(splits):
</span></span><span style=display:flex><span>        print (<span style=color:#e6db74>&#39;Processing &#39;</span> <span style=color:#f92672>+</span>  str(splitindex) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39; of &#39;</span> <span style=color:#f92672>+</span>  str(splits) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39; split data.&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        srcark <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;raw_fbank_&#39;</span> <span style=color:#f92672>+</span> dtag <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;.&#39;</span> <span style=color:#f92672>+</span> str(splitindex <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;.ark&#39;</span>
</span></span><span style=display:flex><span>        srcscp <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;raw_fbank_&#39;</span> <span style=color:#f92672>+</span> dtag <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;.&#39;</span> <span style=color:#f92672>+</span> str(splitindex <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;.scp&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        destark <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;raw_&#39;</span> <span style=color:#f92672>+</span> tags <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;_&#39;</span> <span style=color:#f92672>+</span> dtag <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;.&#39;</span> <span style=color:#f92672>+</span> str(splitindex <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;.ark&#39;</span>
</span></span><span style=display:flex><span>        destscp <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;raw_&#39;</span> <span style=color:#f92672>+</span> tags <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;_&#39;</span> <span style=color:#f92672>+</span> dtag <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;.&#39;</span> <span style=color:#f92672>+</span> str(splitindex <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;.scp&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        srcark_filename <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(fbankfeatdir, srcark)
</span></span><span style=display:flex><span>        destark_filename <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(featdir, destark)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        srcscp_filename <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(fbankfeatdir, srcscp)
</span></span><span style=display:flex><span>        destscp_filename <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(featdir, destscp)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        d <span style=color:#f92672>=</span> kaldiio<span style=color:#f92672>.</span>load_ark(srcark_filename)
</span></span><span style=display:flex><span>        write_dict<span style=color:#f92672>=</span>{} <span style=color:#75715e># kaldiio uses features in the form of a dict</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> key, array <span style=color:#f92672>in</span> d:
</span></span><span style=display:flex><span>            <span style=color:#75715e># check if keys match</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> keys_orig[fileindex] <span style=color:#f92672>!=</span> key :
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#39;ID Mismatch!&#39;</span>)
</span></span><span style=display:flex><span>            fname <span style=color:#f92672>=</span> filenames[fileindex]
</span></span><span style=display:flex><span>            <span style=color:#75715e># read audio, assuming wav file</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># change this if the file is of some other type</span>
</span></span><span style=display:flex><span>	    fs, sig <span style=color:#f92672>=</span> sp<span style=color:#f92672>.</span>io<span style=color:#f92672>.</span>wavfile<span style=color:#f92672>.</span>read(fname)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Do your feature extraction below: </span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># expected shape is (numframes x featdim)</span>
</span></span><span style=display:flex><span>	    newfeat <span style=color:#f92672>=</span> extract_my_feats(sig)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>	    <span style=color:#75715e># do the numframes check, if we are reusing existing alignments</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># else, comment out this check</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> array<span style=color:#f92672>.</span>shape[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>!=</span> newfeat<span style=color:#f92672>.</span>shape[<span style=color:#ae81ff>0</span>] :
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#39;Dimension mismatch!&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># append the features into the dictionary</span>
</span></span><span style=display:flex><span>            write_dict [key] <span style=color:#f92672>=</span> newfeat<span style=color:#f92672>.</span>astype(np<span style=color:#f92672>.</span>float32) <span style=color:#75715e># let us store it as float32</span>
</span></span><span style=display:flex><span>            fileindex <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># write features to disk</span>
</span></span><span style=display:flex><span>        print (<span style=color:#e6db74>&#34;Writing to &#34;</span> <span style=color:#f92672>+</span> destark_filename)
</span></span><span style=display:flex><span>        kaldiio<span style=color:#f92672>.</span>save_ark(destark_filename, write_dict, scp<span style=color:#f92672>=</span>destscp_filename)
</span></span></code></pre></div><p>Notice that <code>kaldiio.save_ark</code> with the <code>scp</code> variable set to a destination name will also generate the scp file together with the ark write. We will next have to generate the <code>feats.scp</code> file by concatenating the scp files which are split into 10 subsets. You can do it in a terminal using:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nj<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> x in test train dev; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    rm -f data-myfeats/$x/feats.scp
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> n in <span style=color:#66d9ef>$(</span>seq $nj<span style=color:#66d9ef>)</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      cat $feat/raw_myfeat_<span style=color:#e6db74>${</span>x<span style=color:#e6db74>}</span>.$n.scp <span style=color:#f92672>||</span> exit 1;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>done</span> &gt; data-myfeats/$name/feats.scp
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>Now you can change the data directory in training scripts to <code>data-myfeats</code> to train and decode using kaldi using your custom features.</p></div><div class=share-section><h4 class=share-title>Share this post</h4><div class=share-buttons><a class="share-btn share-facebook" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fdeepakbaby.in%2fposts%2fkaldi-custom-features%2f" target=_blank rel=noopener aria-label="Share on Facebook"><i class="fab fa-facebook-f"></i>
</a><a class="share-btn share-twitter" href="https://twitter.com/share?url=https%3a%2f%2fdeepakbaby.in%2fposts%2fkaldi-custom-features%2f&text=Training%20kaldi%20models%20with%20custom%20features" target=_blank rel=noopener aria-label="Share on Twitter"><i class="fab fa-twitter"></i>
</a><a class="share-btn share-linkedin" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fdeepakbaby.in%2fposts%2fkaldi-custom-features%2f&title=Training%20kaldi%20models%20with%20custom%20features" target=_blank rel=noopener aria-label="Share on LinkedIn"><i class="fab fa-linkedin-in"></i>
</a><a class="share-btn share-reddit" href="https://reddit.com/submit?url=https%3a%2f%2fdeepakbaby.in%2fposts%2fkaldi-custom-features%2f&title=Training%20kaldi%20models%20with%20custom%20features" target=_blank rel=noopener aria-label="Share on Reddit"><i class="fab fa-reddit-alien"></i>
</a><a class="share-btn share-whatsapp" href="https://api.whatsapp.com/send?text=Training%20kaldi%20models%20with%20custom%20features https%3a%2f%2fdeepakbaby.in%2fposts%2fkaldi-custom-features%2f" target=_blank rel=noopener aria-label="Share on WhatsApp"><i class="fab fa-whatsapp"></i>
</a><a class="share-btn share-email" href="mailto:?subject=Training%20kaldi%20models%20with%20custom%20features&body=https%3a%2f%2fdeepakbaby.in%2fposts%2fkaldi-custom-features%2f" aria-label="Share via Email"><i class="fas fa-envelope"></i></a></div></div><div class=improve-page-section><a href=https://github.com/deepakbaby/deepakbaby-site/edit/main/content/posts/kaldi-custom-features/index.md class=improve-link target=_blank rel=noopener><i class="fas fa-code-branch"></i>
<span>Improve this page</span></a></div><nav class=post-navigation><a href=/posts/keras-multiple-losses/ class="nav-card nav-prev"><span class=nav-label>← Previous</span>
<span class=nav-title>Tracking Multiple Losses with Keras</span>
</a><a href=/posts/kaldi-mkl/ class="nav-card nav-next"><span class=nav-label>Next →</span>
<span class=nav-title>Installing Kaldi with MKL support without root access</span></a></nav><div class=comments-section><h2 class=comments-heading><i class="fas fa-comments"></i>
Discussion</h2><div class=comments-content><div id=comments-container><script src=https://utteranc.es/client.js repo=deepakbaby/deepakbaby-site issue-term=title theme=github-light crossorigin=anonymous async></script></div></div></div></article></div></div><button id=scroll-to-top class=scroll-top-btn aria-label="Scroll to top">
<i class="fas fa-chevron-up"></i></button></div><style>@import 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap';.modern-post-wrapper{font-family:inter,-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;padding-top:5rem;width:100vw;max-width:100vw;overflow-x:hidden;margin:0;padding-left:0;padding-right:0}.post-hero-section{position:relative;min-height:60vh;display:flex;align-items:center;justify-content:center;text-align:center;padding:4rem 2rem;overflow:hidden;background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%)}[data-theme=light] .post-hero-section{background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%)}.post-hero-image{position:absolute;inset:0;background-size:cover;background-position:50%;opacity:.15;z-index:0}[data-theme=light] .post-hero-image{opacity:.08}.post-hero-overlay{position:absolute;inset:0;background:radial-gradient(circle at 30% 50%,rgba(59,130,246,.1) 0%,transparent 50%),radial-gradient(circle at 70% 50%,rgba(139,92,246,.1) 0%,transparent 50%);z-index:1}.post-hero-content{position:relative;z-index:2;max-width:900px;margin:0 auto}.post-meta-badges{margin-bottom:1.5rem}.post-category-badge{display:inline-block;padding:.5rem 1.25rem;background:rgba(59,130,246,.15);border:1px solid rgba(59,130,246,.3);border-radius:50px;color:#60a5fa;font-size:.85rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em}[data-theme=light] .post-category-badge{background:rgba(59,130,246,.1);color:#3b82f6}.post-title{font-size:clamp(2rem,5vw,3.5rem);font-weight:400;line-height:1.1;margin:0 0 2rem;color:#fff;letter-spacing:-.02em}[data-theme=light] .post-title{color:#1e293b}.post-meta-info{display:flex;align-items:center;justify-content:center;gap:1.5rem;flex-wrap:wrap;margin-bottom:1.5rem;color:rgba(255,255,255,.8);font-size:.95rem}[data-theme=light] .post-meta-info{color:#64748b}.post-author{display:flex;align-items:center;gap:.75rem}.author-name{font-weight:600}.post-date-time{display:flex;align-items:center;gap:.5rem;color:rgba(255,255,255,.8)}[data-theme=light] .post-date-time{color:rgba(0,0,0,.7)}.post-date-time svg{width:16px;height:16px;opacity:.7}.meta-separator{opacity:.5}.post-tags-hero{display:flex;align-items:center;justify-content:center;gap:.75rem;flex-wrap:wrap}.tag-link{padding:.375rem 1rem;background:rgba(255,255,255,5%);border:1px solid rgba(255,255,255,.1);border-radius:50px;color:rgba(255,255,255,.8);font-size:.85rem;font-weight:500;text-decoration:none;transition:all .3s}.tag-link:hover{background:rgba(59,130,246,.2);border-color:rgba(59,130,246,.4);color:#60a5fa}[data-theme=light] .tag-link{background:rgba(0,0,0,4%);border-color:rgba(0,0,0,8%);color:#64748b}[data-theme=light] .tag-link:hover{background:rgba(59,130,246,.1);border-color:rgba(59,130,246,.3);color:#3b82f6}.post-content-container{max-width:1400px;margin:0 auto;padding:4rem 2rem}.post-content-grid{display:grid;grid-template-columns:1fr;gap:4rem;align-items:start;width:90%;margin:0 auto}.post-article-content{min-width:0}.prose-content{font-family:inter,-apple-system,BlinkMacSystemFont,segoe ui,system-ui,sans-serif;line-height:1.8;font-size:1.0625rem;font-weight:400}.prose-content h1,.prose-content h2,.prose-content h3,.prose-content h4,.prose-content h5,.prose-content h6{font-family:inter,-apple-system,BlinkMacSystemFont,segoe ui,system-ui,sans-serif!important;font-weight:400!important;line-height:1.4!important;margin-top:2.5rem!important;margin-bottom:1rem!important;color:var(--text-primary)!important;letter-spacing:-.01em!important;border:none!important;border-bottom:none!important;border-top:none!important;text-decoration:none!important;box-shadow:none!important;pointer-events:none!important;cursor:text!important}.prose-content h1::before,.prose-content h2::before,.prose-content h3::before,.prose-content h4::before,.prose-content h5::before,.prose-content h6::before,.prose-content h1::after,.prose-content h2::after,.prose-content h3::after,.prose-content h4::after,.prose-content h5::after,.prose-content h6::after{content:none!important;border:none!important;border-bottom:none!important;text-decoration:none!important}.prose-content h1:hover,.prose-content h2:hover,.prose-content h3:hover,.prose-content h4:hover,.prose-content h5:hover,.prose-content h6:hover,.prose-content h1:target,.prose-content h2:target,.prose-content h3:target,.prose-content h4:target,.prose-content h5:target,.prose-content h6:target,.prose-content h1[id],.prose-content h2[id],.prose-content h3[id],.prose-content h4[id],.prose-content h5[id],.prose-content h6[id]{text-decoration:none!important;border-bottom:none!important;cursor:text!important}.prose-content h1{font-size:2.25rem}.prose-content h2{font-size:1.875rem}.prose-content h3{font-size:1.5rem}.prose-content h4{font-size:1.25rem}.prose-content h5{font-size:1.125rem}.prose-content h6{font-size:1rem}.prose-content p{margin-bottom:1.5rem;color:var(--text-primary)}.prose-content a{color:#3b82f6;text-decoration:underline;text-underline-offset:3px;transition:color .2s}.prose-content a:hover{color:#60a5fa}.prose-content ul,.prose-content ol{margin-bottom:1.5rem;padding-left:1.75rem}.prose-content li{margin-bottom:.5rem}.prose-content blockquote{border-left:4px solid #3b82f6;padding-left:1.5rem;margin:1.5rem 0;font-style:italic;color:var(--text-secondary)}.prose-content code{background:rgba(59,130,246,.1);padding:.2em .4em;border-radius:4px;font-size:.9em;font-family:courier new,monospace;color:#3b82f6}[data-theme=light] .prose-content code{background:rgba(59,130,246,8%)}.prose-content pre{background:rgba(0,0,0,.3);padding:1.5rem;border-radius:12px;overflow-x:auto;margin:1.5rem 0;border:1px solid rgba(255,255,255,.1)}[data-theme=light] .prose-content pre{background:#f8fafc;border-color:rgba(0,0,0,8%)}.prose-content pre code{background:0 0;padding:0;color:inherit}.prose-content img{max-width:100%;height:auto;border-radius:12px;margin:2rem 0}.prose-content table{width:100%;border-collapse:collapse;margin:1.5rem 0}.prose-content th,.prose-content td{border:1px solid rgba(255,255,255,.1);padding:.75rem;text-align:left}[data-theme=light] .prose-content th,[data-theme=light] .prose-content td{border-color:rgba(0,0,0,8%)}.prose-content th{background:rgba(59,130,246,.1);font-weight:600}.prose-content hr{border:none;border-top:1px solid rgba(255,255,255,.1);margin:3rem 0}[data-theme=light] .prose-content hr{border-top-color:rgba(0,0,0,8%)}.prose-content .katex{font-size:1.1em}.prose-content .katex-display{overflow-x:auto;overflow-y:hidden;padding:1rem 0}.share-section{margin-top:4rem;padding-top:2rem;border-top:1px solid rgba(255,255,255,.1)}[data-theme=light] .share-section{border-top-color:rgba(0,0,0,8%)}.share-title{font-size:1.125rem;font-weight:600;margin-bottom:1rem;color:var(--text-primary)}.share-buttons{display:flex;gap:.75rem;flex-wrap:wrap}.share-btn{display:flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,5%);border:1px solid rgba(255,255,255,.1);color:var(--text-secondary);text-decoration:none;transition:all .3s}.share-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2)}.share-facebook:hover{background:#1877f2;border-color:#1877f2;color:#fff}.share-twitter:hover{background:#1da1f2;border-color:#1da1f2;color:#fff}.share-linkedin:hover{background:#0a66c2;border-color:#0a66c2;color:#fff}.share-reddit:hover{background:#ff4500;border-color:#ff4500;color:#fff}.share-whatsapp:hover{background:#25d366;border-color:#25d366;color:#fff}.share-email:hover{background:#6b7280;border-color:#6b7280;color:#fff}.improve-page-section{margin-top:3rem;text-align:center}.improve-link{display:inline-flex;align-items:center;gap:.5rem;padding:.75rem 1.5rem;background:rgba(255,255,255,5%);border:1px solid rgba(255,255,255,.1);border-radius:50px;color:var(--text-secondary);text-decoration:none;font-weight:500;transition:all .3s}.improve-link:hover{background:rgba(59,130,246,.1);border-color:rgba(59,130,246,.3);color:#3b82f6}.post-navigation{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-top:4rem}.nav-card{padding:1.5rem;background:rgba(255,255,255,3%);border:1px solid rgba(255,255,255,8%);border-radius:12px;text-decoration:none;transition:all .3s;display:flex;flex-direction:column;gap:.5rem}[data-theme=light] .nav-card{background:rgba(255,255,255,.6);border-color:rgba(0,0,0,8%)}.nav-card:hover{border-color:rgba(59,130,246,.3);transform:translateY(-2px);box-shadow:0 8px 20px rgba(59,130,246,.1)}.nav-label{font-size:.875rem;color:var(--text-muted);font-weight:500}.nav-title{font-size:1.125rem;font-weight:600;color:var(--text-primary)}.comments-section{margin-top:5rem;padding-top:3rem;border-top:2px solid rgba(255,255,255,.1)}[data-theme=light] .comments-section{border-top-color:rgba(0,0,0,8%)}.comments-heading{font-size:1.75rem;font-weight:700;margin-bottom:2rem;color:var(--text-primary);display:flex;align-items:center;gap:.75rem}.comments-heading i{color:#3b82f6}.scroll-top-btn{position:fixed;bottom:2rem;right:2rem;width:50px;height:50px;border-radius:50%;background:rgba(59,130,246,.9);border:none;color:#fff;font-size:1.25rem;cursor:pointer;opacity:0;visibility:hidden;transition:all .3s;box-shadow:0 4px 12px rgba(59,130,246,.3);z-index:100}.scroll-top-btn.visible{opacity:1;visibility:visible}.scroll-top-btn:hover{background:#3b82f6;transform:translateY(-4px);box-shadow:0 8px 20px rgba(59,130,246,.4)}@media(max-width:768px){.modern-post-wrapper{padding-top:4rem}.post-hero-section{min-height:50vh;padding:3rem 1.5rem}.post-title{font-size:2rem}.post-meta-info{flex-direction:column;gap:1rem}.post-content-container{padding:2rem 1.5rem}.post-content-grid{width:90%}.prose-content{font-size:1rem}.prose-content h1{font-size:1.875rem}.prose-content h2{font-size:1.5rem}.prose-content h3{font-size:1.25rem}.scroll-top-btn{bottom:1.5rem;right:1.5rem;width:44px;height:44px}}</style><script>(function(){"use strict";const e=document.getElementById("scroll-to-top");window.addEventListener("scroll",()=>{window.pageYOffset>300?e.classList.add("visible"):e.classList.remove("visible")}),e.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})})})()</script></div><footer class=modern-footer><div class=footer-glow></div><div class=footer-container><div class=footer-content><div class=footer-brand><span class=brand-name>Deepak Baby</span><p class=brand-tagline>Senior Data Scientist at KBC Bank & Verzekering</p></div><div class=footer-social><a href=mailto:deepakbabycet@gmail.com class=social-icon aria-label=Email title=Email><i class="fas fa-envelope"></i>
</a><a href=https://www.github.com/deepakbaby class=social-icon target=_blank rel="noopener noreferrer" aria-label=Github title=Github><i class="fab fa-github"></i>
</a><a href=https://www.linkedin.com/in/deepakbaby/ class=social-icon target=_blank rel="noopener noreferrer" aria-label=LinkedIn title=LinkedIn><i class="fab fa-linkedin"></i>
</a><a href="https://scholar.google.com/citations?user=69q7FOYAAAAJ&amp;hl=en" class=social-icon target=_blank rel="noopener noreferrer" aria-label="Google Scholar" title="Google Scholar"><i class="fa-brands fa-google-scholar"></i></a></div><div class=footer-links><a href=#hero>Home</a>
<a href=#about>About</a>
<a href=#experiences>Experience</a>
<a href=#posts>Blog</a>
<a href=#publications>Publications</a></div></div><div class=footer-bottom><p class=copyright>© 2025 Deepak Baby. All rights reserved.</p><p class=credits>Made with <span class=heart>❤</span>, Hugo and Claude</p></div></div></footer><style>.modern-footer{position:relative;background:#050506;padding:4rem 0 2rem;overflow:hidden}.footer-glow{position:absolute;top:0;left:50%;transform:translateX(-50%);width:600px;height:2px;background:linear-gradient(90deg,transparent 0%,#3b82f6 25%,#1d4ed8 50%,#3b82f6 75%,transparent 100%);filter:blur(1px)}.footer-container{max-width:1200px;margin:0 auto;padding:0 2rem}.footer-content{display:flex;flex-direction:column;align-items:center;text-align:center;gap:2rem;margin-bottom:3rem}.footer-brand{margin-bottom:.5rem}.brand-name{font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,#fff 0%,#a78bfa 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.brand-tagline{font-size:.9rem;color:#6b7280;margin:.5rem 0 0}.footer-social{display:flex;gap:1rem}.social-icon{width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,5%);border:1px solid rgba(255,255,255,8%);display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:1.1rem;text-decoration:none;transition:all .3s ease}.social-icon:hover{background:linear-gradient(135deg,#8b5cf6 0%,#3b82f6 100%);border-color:transparent;color:#fff;transform:translateY(-4px);box-shadow:0 8px 25px rgba(139,92,246,.3)}.footer-links{display:flex;flex-wrap:wrap;justify-content:center;gap:1.5rem}.footer-links a{color:#6b7280;text-decoration:none;font-size:.9rem;transition:color .3s}.footer-links a:hover{color:#a78bfa}.footer-bottom{border-top:1px solid rgba(255,255,255,5%);padding-top:2rem;display:flex;flex-direction:column;align-items:center;gap:.5rem}.copyright{font-size:.875rem;color:#4b5563;margin:0}.credits{font-size:.75rem;color:#374151;margin:0}.heart{color:#ef4444;animation:heartbeat 1.5s infinite}@keyframes heartbeat{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}@media(min-width:768px){.footer-content{flex-direction:row;justify-content:space-between;text-align:left}.footer-bottom{flex-direction:row;justify-content:space-between}}</style><script src=/application.f6959e0d840b2a0cb8ebdc7b64f82c76ed540bafda2e2f31ece1d91e812ba4d1.js integrity="sha256-9pWeDYQLKgy469x7ZPgsdu1UC6/aLi8x7OHZHoErpNE=" defer></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}],throwOnError:!1,strict:!1})'></script><script src=/js/collapsible-sidebars.js></script></body></html>